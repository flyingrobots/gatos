#!/usr/bin/env bash
set -euo pipefail

top="$(git rev-parse --show-toplevel)"
cd "$top"

if [[ "${PREPUSH_LINT:-0}" = "1" ]]; then
  echo "[pre-push] markdown lint (enabled via PREPUSH_LINT=1)"
  if command -v rumdl >/dev/null 2>&1; then
    rumdl check .
  elif command -v cargo >/dev/null 2>&1; then
    cargo run -p xtask -- md
  elif command -v node >/dev/null 2>&1; then
    npx -y markdownlint-cli@0.45.0 "**/*.md" --config .markdownlint.json
  elif command -v docker >/dev/null 2>&1; then
    # Pin Node image digest for reproducibility
    docker run --rm -v "$PWD:/work" -w /work node@sha256:47dacd49500971c0fbe602323b2d04f6df40a933b123889636fc1f76bf69f58a \
      npx -y markdownlint-cli@0.45.0 "**/*.md" --config .markdownlint.json
  else
    echo "[pre-push][WARN] PREPUSH_LINT=1 set but no linter is available; skipping" >&2
  fi
fi


# Docs normalize (AST) — block if normalization would change files
if [[ "${PREPUSH_NORMALIZE:-0}" = "1" ]]; then
  if command -v node >/dev/null 2>&1; then
    echo "[pre-push] docs normalize:check (unified/remark)"
    if ! npm run -s docs:normalize:check; then
      echo "[pre-push][ERROR] docs are not normalized. Run: npm run docs:normalize" >&2
      exit 1
    fi
  else
    echo "[pre-push][WARN] Node is not available; skipping docs normalize check" >&2
  fi
fi

# Docs build (VitePress) — can skip via PREPUSH_SKIP_DOCS=1
if [[ "${PREPUSH_SKIP_DOCS:-0}" != "1" ]]; then
  if command -v npm >/dev/null 2>&1; then
    echo "[pre-push] docs:build (vitepress)"
    npm run -s docs:build
  else
    echo "[pre-push][WARN] npm not available; skipping docs build" >&2
  fi
fi

# Mermaid verify — can skip via PREPUSH_SKIP_MERMAID=1
if [[ "${PREPUSH_SKIP_MERMAID:-0}" != "1" ]]; then
  if [[ -x "./scripts/diagrams.sh" ]]; then
    echo "[pre-push] Mermaid verify (scripts/diagrams.sh --verify --all)"
    MERMAID_MAX_PARALLEL=${MERMAID_MAX_PARALLEL:-6} bash ./scripts/diagrams.sh --verify --all
  else
    echo "[pre-push][WARN] scripts/diagrams.sh missing; skipping Mermaid verify" >&2
  fi
fi


# Quick Rust hygiene (fast): rustfmt check and cargo check (can skip via PREPUSH_SKIP_RUST=1)
if [[ "${PREPUSH_SKIP_RUST:-0}" != "1" ]]; then
  if command -v cargo >/dev/null 2>&1; then
    echo "[pre-push] cargo fmt --check"
    if ! cargo fmt --all -- --check; then
      echo "[pre-push][ERROR] rustfmt check failed" >&2
      exit 1
    fi
    echo "[pre-push] cargo check (workspace)"
    if ! cargo check --workspace -q; then
      echo "[pre-push][ERROR] cargo check failed" >&2
      exit 1
    fi
    if command -v dprint >/dev/null 2>&1; then
      echo "[pre-push] dprint check (JSON/YAML)"
      if ! dprint check; then
        echo "[pre-push][ERROR] dprint check failed" >&2
        exit 1
      fi
    else
      echo "[pre-push][WARN] dprint not found; skipping JSON/YAML format check" >&2
    fi
  else
    echo "[pre-push][WARN] cargo not found; skipping Rust checks" >&2
  fi
fi

echo "[pre-push] OK"
