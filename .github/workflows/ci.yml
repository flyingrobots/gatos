name: CI

on:
  pull_request:
    branches: ["**"]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  editorconfig:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: EditorConfig check
        uses: editorconfig-checker/action-editorconfig-checker@v2
        with:
          version: '2.7.0'

  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: rustfmt --check
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: clippy (workspace default features)
        run: cargo clippy --workspace -- -D warnings
      - name: clippy (gatos-ledger core-only)
        run: cargo clippy -p gatos-ledger --no-default-features --features core-only -- -D warnings

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (workspace)
        run: cargo test --workspace --locked
      - name: cargo test (gatos-ledger core-only)
        run: cargo test -p gatos-ledger --no-default-features --features core-only --locked
      - name: FFI test coverage
        run: cargo test -p gatos-ffi-bindings --locked
      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - name: WASM target build verification
        run: cargo build -p gatos-wasm-bindings --target wasm32-unknown-unknown --locked

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.81.0
      - name: Dependency vulnerability audit
        uses: rustsec/audit-check-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
