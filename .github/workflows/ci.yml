name: CI

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  editorconfig:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: EditorConfig check
        uses: editorconfig-checker/action-editorconfig-checker@v2
        with:
          version: '2.7.0'

  fmt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.81.0
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      - name: rustfmt --check
        run: cargo fmt --all -- --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.81.0
          components: clippy
      - uses: Swatinem/rust-cache@v2
      - name: clippy (workspace default features)
        run: cargo clippy --workspace -- -D warnings
      - name: clippy (gatos-ledger core-only)
        run: cargo clippy -p gatos-ledger --no-default-features --features core-only -- -D warnings

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.81.0
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (workspace)
        run: cargo test --workspace --locked
      - name: cargo test (gatos-ledger core-only)
        run: cargo test -p gatos-ledger --no-default-features --features core-only --locked
      - name: FFI test coverage
        run: cargo test -p gatos-ffi-bindings --locked
      - name: Install wasm32 target
        run: rustup target add wasm32-unknown-unknown
      - name: WASM target build verification
        run: cargo build -p gatos-wasm-bindings --target wasm32-unknown-unknown --locked
      - name: cargo test (doc tests)
        run: cargo test --workspace --doc --locked

  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.81.0
      - name: Dependency vulnerability audit
        uses: actions-rs/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

  msrv:
    runs-on: ubuntu-latest
    name: MSRV check (1.81.0)
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: 1.81.0
      - uses: Swatinem/rust-cache@v2
      - name: cargo test (MSRV)
        run: cargo test --workspace --locked

  markdownlint:
    runs-on: ubuntu-latest
    name: Markdownlint
    steps:
      - uses: actions/checkout@v4
      - name: Cache npm (npx)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-20-npx-cache-v1
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: markdownlint (check only)
        run: npx -y markdownlint-cli "**/*.md" --config .markdownlint.json

  schemas:
    runs-on: ubuntu-latest
    name: Schema validation (v1)
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install ajv-cli and formats (pinned)
        run: npm i -g ajv-cli@5.0.0 ajv-formats@3.0.1
      - name: Compile schemas (v1)
        run: |
          set -euo pipefail
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/job/job_manifest.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/job/proof_of_execution_envelope.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/proposal.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/approval.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/grant.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/revocation.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/proof_of_consensus_envelope.schema.json -r schemas/v1/common/ids.schema.json
          ajv compile --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/policy/governance_policy.schema.json
      - name: Validate examples (v1)
        run: |
          set -euo pipefail
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/job/job_manifest.schema.json -d examples/v1/job/manifest_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/job/proof_of_execution_envelope.schema.json -d examples/v1/job/poe_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/proposal.schema.json -d examples/v1/governance/proposal_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/approval.schema.json -d examples/v1/governance/approval_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/grant.schema.json -d examples/v1/governance/grant_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/revocation.schema.json -d examples/v1/governance/revocation_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/governance/proof_of_consensus_envelope.schema.json -d examples/v1/governance/poc_envelope_min.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s schemas/v1/policy/governance_policy.schema.json -d examples/v1/policy/governance_min.json
      - name: Additional encoding tests (ed25519 base64url forms)
        run: |
          set -euo pipefail
          # Root schemas that reference defs
          echo '{"$schema":"https://json-schema.org/draft/2020-12/schema","$ref":"schemas/v1/common/ids.schema.json#/$defs/ed25519Key"}' > /tmp/ed25519Key.schema.json
          echo '{"$schema":"https://json-schema.org/draft/2020-12/schema","$ref":"schemas/v1/common/ids.schema.json#/$defs/ed25519Sig"}' > /tmp/ed25519Sig.schema.json
          # Positive: base64url unpadded (32B -> 43 chars), (64B -> 86 chars)
          echo '"ed25519:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"' > /tmp/key_b64url_unpadded.json
          echo '"ed25519:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"' > /tmp/sig_b64url_unpadded.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s /tmp/ed25519Key.schema.json -d /tmp/key_b64url_unpadded.json -r schemas/v1/common/ids.schema.json
          ajv validate --spec=draft2020 --strict=true -c ajv-formats -s /tmp/ed25519Sig.schema.json -d /tmp/sig_b64url_unpadded.json -r schemas/v1/common/ids.schema.json
          # Negative: wrongly unpadded to 44/88 chars (should be rejected)
          echo '"ed25519:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"' > /tmp/key_b64url_badlen.json
          echo '"ed25519:AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"' > /tmp/sig_b64url_badlen.json
          if ajv validate --spec=draft2020 --strict=true -c ajv-formats -s /tmp/ed25519Key.schema.json -d /tmp/key_b64url_badlen.json -r schemas/v1/common/ids.schema.json; then
            echo "Unexpected success: 44-char base64url key without '=' should be rejected" >&2; exit 1; fi
          if ajv validate --spec=draft2020 --strict=true -c ajv-formats -s /tmp/ed25519Sig.schema.json -d /tmp/sig_b64url_badlen.json -r schemas/v1/common/ids.schema.json; then
            echo "Unexpected success: 88-char base64url sig without '==' should be rejected" >&2; exit 1; fi

  # (removed duplicate markdownlint job id)

  diagrams:
    runs-on: ubuntu-latest
    name: Mermaid Diagrams Up-to-date
    steps:
      - uses: actions/checkout@v4
      - name: Cache npm (npx)
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-20-npx-cache-v1
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Generate Mermaid diagrams (full repo)
        run: MERMAID_MAX_PARALLEL=6 node scripts/mermaid/generate.mjs --all
      - name: Fail if generation produced diffs
        run: git diff --exit-code -- docs/diagrams/generated || (echo "Run 'make diagrams' (or 'node scripts/mermaid/generate.mjs --all') and commit updated diagrams" && exit 1)
      - name: Install ajv-cli and formats (pinned) for negative tests
        run: npm i -g ajv-cli@5.0.0 ajv-formats@3.0.1
      - name: Negative tests (invalid ISO8601 durations)
        run: |
          set -euo pipefail
          echo '{"governance":{"x":{"ttl":"P"}}}' > /tmp/bad1.json
          echo '{"governance":{"x":{"ttl":"PT"}}}' > /tmp/bad2.json
          if ajv validate --spec=draft2020 --strict=true -c ajv-formats \
               -s schemas/v1/policy/governance_policy.schema.json -d /tmp/bad1.json; then
            echo "Unexpected success: ttl=P should be rejected" >&2
            exit 1
          else
            echo "Rejected bad ttl P as expected"
          fi
          if ajv validate --spec=draft2020 --strict=true -c ajv-formats \
               -s schemas/v1/policy/governance_policy.schema.json -d /tmp/bad2.json; then
            echo "Unexpected success: ttl=PT should be rejected" >&2
            exit 1
          else
            echo "Rejected bad ttl PT as expected"
          fi
  linkcheck:
    runs-on: ubuntu-latest
    name: Link Check (lychee)
    steps:
      - uses: actions/checkout@v4
      - uses: lycheeverse/lychee-action@v2
        with:
          args: --no-progress --config ./.lychee.toml **/*.md
          fail: true
