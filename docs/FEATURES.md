# GATOS — FEATURES (derived from SPEC v0.3)
<a id="gatos-features-derived-from-spec-v0.3"></a>
<!-- AUTOGENERATED TOC START -->
- [F1 — Append-Only Journals (FF-only refs)](#f1-append-only-journals-ff-only-refs)
  - [F1-US-DEV](#f1-us-dev)
    - [F1 Acceptance Criteria & DoR](#f1-acceptance-criteria-dor)
    - [F1 Test Plan](#f1-test-plan)
  - [F1-US-SEC](#f1-us-sec)
    - [F1 Acceptance Criteria](#f1-acceptance-criteria)
    - [F1 Test Plan](#f1-test-plan)
- [F2 — Deterministic Folds & State Roots](#f2-deterministic-folds-state-roots)
  - [F2-US-DEV](#f2-us-dev)
    - [F2 Acceptance Criteria](#f2-acceptance-criteria)
    - [F2 Test Plan](#f2-test-plan)
- [F3 — Policy Gate (Pure, Deterministic)](#f3-policy-gate-pure-deterministic)
  - [F3-US-SEC](#f3-us-sec)
    - [F3 Acceptance Criteria](#f3-acceptance-criteria)
    - [F3 Test Plan](#f3-test-plan)
- [F4 — Capability Grants & Trust Graph](#f4-capability-grants-trust-graph)
  - [F4-US-PENG](#f4-us-peng)
    - [F4 Acceptance Criteria](#f4-acceptance-criteria)
    - [F4 Test Plan](#f4-test-plan)
- [F5 — Message Bus (QoS with Acks/Commits)](#f5-message-bus-qos-with-ackscommits)
  - [F5-US-SRE](#f5-us-sre)
    - [F5 Acceptance Criteria](#f5-acceptance-criteria)
    - [F5 Test Plan](#f5-test-plan)
- [F6 — Opaque Pointers & CAS](#f6-opaque-pointers-cas)
  - [F6-US-DML](#f6-us-dml)
    - [F6 Acceptance Criteria](#f6-acceptance-criteria)
    - [F6 Test Plan](#f6-test-plan)
- [F7 — Epochs & Compaction](#f7-epochs-compaction)
  - [F7-US-PENG](#f7-us-peng)
    - [F7 Acceptance Criteria](#f7-acceptance-criteria)
    - [F7 Test Plan](#f7-test-plan)
- [F8 — Observability & Doctor](#f8-observability-doctor)
  - [F8-US-SRE](#f8-us-sre)
    - [F8 Acceptance Criteria](#f8-acceptance-criteria)
    - [F8 Test Plan](#f8-test-plan)

<!-- AUTOGENERATED TOC END -->

<a id="gatos-features-derived-from-spec-v0.3"></a>

Each feature includes user stories per relevant stakeholders (format requested), definition of ready, and test plan.

---

## F1 — Append-Only Journals (FF-only refs)
<a id="f1-append-only-journals-ff-only-refs"></a>
### F1-US-DEV
<a id="f1-us-dev"></a>
|   |   |
|--|--|
| **As a...** | App Developer |
| **I want..** | to append events atomically and read them back deterministically |
| **So that...** | I can build features on top of a stable event log without racey states |

#### F1 Acceptance Criteria & DoR
<a id="acceptance-criteria-dor"></a>
- [ ] Atomic CAS update-ref used on every append
- [ ] Denormalized canonical JSON recorded
- [ ] Appends visible via `git log` and via JSONL stream

#### F1 Test Plan
<a id="test-plan"></a>
- [ ] Golden: append N events, verify ancestry and order
- [ ] Edge: concurrent append from 3 writers (two must retry)
- [ ] Failure: attempt non-FF update → rejected

---

### F1-US-SEC
<a id="f1-us-sec"></a>
|   |   |
|--|--|
| **As a...** | Security/Compliance |
| **I want..** | denies to produce audit entries with rule IDs |
| **So that...** | all rejections are explainable and traceable |

#### F1 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] Every deny → `audit.decision` with rule and reason
- [ ] Policy_root and trust_chain recorded

#### F1 Test Plan
<a id="test-plan"></a>
- [ ] Golden: missing cap → DENY with rule
- [ ] Edge: expired grant → DENY with `expired` reason
- [ ] Failure: tampered audit record → verification fails

---

## F2 — Deterministic Folds & State Roots
<a id="f2-deterministic-folds-state-roots"></a>
### F2-US-DEV
<a id="f2-us-dev"></a>
|   |   |
|--|--|
| **As a...** | App Developer |
| **I want..** | byte-identical state from the same inputs |
| **So that...** | bugs are reproducible across machines |

#### F2 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] Canonical serializer used; BLAKE3 hash stable across OS/arch
- [ ] Fold spec validated before run

#### F2 Test Plan
<a id="test-plan"></a>
- [ ] Golden vectors across linux/macOS/windows
- [ ] Edge: empty input corpus
- [ ] Failure: non-canonical payload ordering → hash mismatch detected

---

## F3 — Policy Gate (Pure, Deterministic)
<a id="f3-policy-gate-pure-deterministic"></a>
### F3-US-SEC
<a id="f3-us-sec"></a>
|   |   |
|--|--|
| **As a...** | Security/Compliance |
| **I want..** | a pure policy VM with deterministic results |
| **So that...** | replay/audit is possible offline |

#### F3 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] Policy VM forbids I/O, clock, RNG
- [ ] `policy_root` bound to every ALLOW

#### F3 Test Plan
<a id="test-plan"></a>
- [ ] Golden: same intent twice → same verdict bytes
- [ ] Edge: rule shadowing order deterministic
- [ ] Failure: impure policy attempt → build fails

---

## F4 — Capability Grants & Trust Graph
<a id="f4-capability-grants-trust-graph"></a>
### F4-US-PENG
<a id="f4-us-peng"></a>
|   |   |
|--|--|
| **As a...** | Platform Engineer |
| **I want..** | N-of-M updates to trust data |
| **So that...** | no single maintainer can subvert policy |

#### F4 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] Quorum thresholds enforced
- [ ] Grant chains verify ancestry

#### F4 Test Plan
<a id="test-plan"></a>
- [ ] Golden: 2-of-3 signers → apply
- [ ] Edge: revoked signer → invalid
- [ ] Failure: split graph → reconcile requires governance merge

---

## F5 — Message Bus (QoS with Acks/Commits)
<a id="f5-message-bus-qos-with-ackscommits"></a>
### F5-US-SRE
<a id="f5-us-sre"></a>
|   |   |
|--|--|
| **As a...** | SRE |
| **I want..** | exactly-once delivery for job dispatch |
| **So that...** | batch jobs don’t double-run under retries |

#### F5 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] `gmb.msg` + `gmb.ack` + `gmb.commit` protocol
- [ ] De-dup by (topic, ulid)

#### F5 Test Plan
<a id="test-plan"></a>
- [ ] Golden: dup publishes + consumer crash → single effect
- [ ] Edge: ack lag metrics emitted
- [ ] Failure: commitment without acks → reject

---

## F6 — Opaque Pointers & CAS
<a id="f6-opaque-pointers-cas"></a>
### F6-US-DML
<a id="f6-us-dml"></a>
|   |   |
|--|--|
| **As a...** | Data/ML Engineer |
| **I want..** | encrypted artifacts with verifiable pointers |
| **So that...** | I can ship models across untrusted storage |

#### F6 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] Pointer includes plaintext hash, ciphertext hash, cipher meta
- [ ] Rekey operation available

#### F6 Test Plan
<a id="test-plan"></a>
- [ ] Golden: decrypt with correct key → match plaintext hash
- [ ] Edge: wrong bytes → hash mismatch
- [ ] Failure: rekey without authorization → deny

---

## F7 — Epochs & Compaction
<a id="f7-epochs-compaction"></a>
### F7-US-PENG
<a id="f7-us-peng"></a>
|   |   |
|--|--|
| **As a...** | Platform Engineer |
| **I want..** | to bound clone size and keep continuity |
| **So that...** | new nodes sync fast without losing history |

#### F7 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] `gatos epoch new` creates anchor
- [ ] New clones fetch current epoch + anchors
- [ ] Verification across epochs

#### F7 Test Plan
<a id="test-plan"></a>
- [ ] Golden: verify continuity hashes
- [ ] Edge: orphaned refs detected by doctor
- [ ] Failure: missing anchor → verification fails

---

## F8 — Observability & Doctor
<a id="f8-observability-doctor"></a>
### F8-US-SRE
<a id="f8-us-sre"></a>
|   |   |
|--|--|
| **As a...** | SRE |
| **I want..** | health endpoints and a doctor tool |
| **So that...** | I can detect drift, cache staleness, and pack bloat |

#### F8 Acceptance Criteria
<a id="acceptance-criteria"></a>
- [ ] `/healthz`, `/readyz`, `/metrics` exposed
- [ ] `gatos doctor` covers refs, packs, epochs, caches

#### F8 Test Plan
<a id="test-plan"></a>
- [ ] Golden: metrics show non-zero counters post workload
- [ ] Edge: cache stale → doctor recommends rebuild
- [ ] Failure: FF-only violation → doctor flags critical
