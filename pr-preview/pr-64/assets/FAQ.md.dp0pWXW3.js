import{_ as a,c as e,o as s,a3 as t}from"./chunks/framework.BXNB9gP7.js";const u=JSON.parse('{"title":"FAQ","description":"","frontmatter":{},"headers":[],"relativePath":"FAQ.md","filePath":"FAQ.md","lastUpdated":1763130617000}'),l={name:"FAQ.md"};function o(n,i,r,d,h,p){return s(),e("div",{"data-pagefind-body":!0},[...i[0]||(i[0]=[t(`<h1 id="faq" tabindex="-1">FAQ <a class="header-anchor" href="#faq" aria-label="Permalink to &quot;FAQ&quot;">‚Äã</a></h1><p><a id="faq"></a></p><ul><li><a href="#1">1) Fold compilation ‚Äî interpreted YAML or compiled?</a></li><li><a href="#2">2) Echo integration ‚Äî do DPO rules become merge strategy for sessions?</a></li><li><a href="#3">3) Proof system ‚Äî ZK choice?</a><ul><li><a href="#phase-plan">Phase plan</a><ul><li><a href="#v1-day-one">v1 (day-one)</a></li><li><a href="#v2-optional-pluggable">v2 (optional, pluggable)</a></li></ul></li><li><a href="#trait">Trait</a></li><li><a href="#spec-tweak">Spec tweak</a></li></ul></li><li><a href="#4">4) Message bus scaling ‚Äî changing shard count</a></li><li><a href="#5">5) Policy language (<code>.rgs</code>) ‚Äî what is it really?</a><ul><li><a href="#features">Features</a></li><li><a href="#shape">Shape</a></li><li><a href="#compilation">Compilation</a></li><li><a href="#library">Library</a></li><li><a href="#explainability">Explainability</a></li></ul></li><li><a href="#obvious-gaps-we-should-close-specification-supplements">Obvious gaps we should close (specification supplements)</a><ul><li><a href="#1">1. <strong>Bind fold version</strong></a></li><li><a href="#2">2. <strong>Canonical JSON rules</strong></a></li><li><a href="#3">3. Error code taxonomy (for JSONL)</a></li><li><a href="#4">4. Resource URIs</a></li><li><a href="#5">5. Idempotency</a></li><li><a href="#6">6. Key rotation</a></li></ul></li><li><a href="#top-5-use-cases-and-if-we-meet-them">Top 5 use-cases (and if we meet them)</a><ul><li><a href="#1">1.Regulated config / feature flags</a></li><li><a href="#2">2.Supply-chain / deploy attestation</a></li><li><a href="#3">3.Air-gapped ML registry</a></li><li><a href="#4">4.LLM multi-agent orchestration</a></li><li><a href="#5">5.Cross-app data sharing (RLS-gated state)</a></li></ul></li><li><a href="#compare-contrast-adjacent-tech">Compare &amp; contrast (adjacent tech)</a><ul><li><a href="#kafka-eventstoredb-event-logs-at-scale">Kafka / EventStoreDB ‚Äî event logs at scale</a><ul><li><a href="#gatos">GATOS</a></li></ul></li><li><a href="#dolt-lakefs-data-versioning-with-git-like-semantics">Dolt / LakeFS ‚Äî data versioning with Git-like semantics</a><ul><li><a href="#gatos">GATOS</a></li></ul></li><li><a href="#dvc-pachyderm-ml-artifact-pipeline-versioning">DVC / Pachyderm ‚Äî ML artifact + pipeline versioning</a><ul><li><a href="#gatos">GATOS</a></li></ul></li></ul></li><li><a href="#nixguix-reproducible-builds">Nix/Guix ‚Äî reproducible builds</a></li><li><a href="#blockchains-global-consensus">Blockchains ‚Äî global consensus</a></li><li><a href="#new-features-this-meditation-suggests">New features this meditation suggests</a></li><li><a href="#concrete-next-steps">Concrete next steps</a><ul><li><a href="#what-works-and-what-does-not">‚úÖ What works (and what does not)</a></li><li><a href="#deterministic-runtime-profile-echolua">Deterministic runtime profile (‚ÄúEchoLua‚Äù)</a></li></ul></li><li><a href="#architecture">üéØ Architecture</a><ul><li><a href="#1">1) Compilation pipeline</a></li><li><a href="#2">2) Execution</a></li><li><a href="#3">3) Standard library (deterministic subset)</a></li></ul></li><li><a href="#determinism-hazards-how-we-neutralize-them">üß™ Determinism hazards &amp; how we neutralize them</a><ul><li><a href="#1">1. Floating-point drift</a></li><li><a href="#2">2.Table iteration order</a></li><li><a href="#3">3.Randomness/time</a></li><li><a href="#4">4.GC/finalizers</a></li><li><a href="#5">5.Bytecode portability</a></li><li><a href="#6">6.String hashing / locales</a></li><li><a href="#where-lua-shines-here">Where Lua shines here</a></li></ul></li><li><a href="#spec-deltas-to-support-echolua">Spec deltas to support EchoLua</a><ul><li><a href="#add-these-to-spectech-spec">Add these to <code>SPEC/TECH-SPEC</code></a></li></ul></li><li><a href="#minimal-example">Minimal example</a><ul><li><a href="#foldsinvoices.lua-authoring">folds/invoices.lua (authoring)</a></li><li><a href="#build">Build</a></li><li><a href="#checkpoint-conceptual">Checkpoint (conceptual)</a></li></ul></li><li><a href="#performance-notes">Performance notes</a></li><li><a href="#test-matrix-lock-this-down">Test matrix (lock this down)</a></li><li><a href="#bottom-line">Bottom line</a></li></ul><p><a id="faq"></a></p><p>Yes. Holy shit indeed.</p><p>Let‚Äôs lock it in with clear answers to your questions, call out any missing pieces, and tighten a few bolts so the implementation path is zero-ambiguity.</p><hr><p>Direct answers to your 5 previous questions:</p><h2 id="_1-fold-compilation-‚Äî-interpreted-yaml-or-compiled" tabindex="-1">1) Fold compilation ‚Äî interpreted YAML or compiled? <a class="header-anchor" href="#_1-fold-compilation-‚Äî-interpreted-yaml-or-compiled" aria-label="Permalink to &quot;1) Fold compilation ‚Äî interpreted YAML or compiled?&quot;">‚Äã</a></h2><p><a id="1"></a><a id="1-fold-compilation--interpreted-yaml-or-compiled"></a><a id="1-fold-compilation-interpreted-yaml-or-compiled"></a><strong>Decision</strong>: Compile the fold spec to a deterministic bytecode (‚ÄúRMG-IR‚Äù), then run it on the Echo engine.</p><p><strong>Source</strong>: <code>folds/*.yaml</code> remains the human-authored DSL (stable, declarative).</p><p><strong>Compiler output</strong>: <code>folds/*.rgf</code> (RMG Fold) canonical CBOR/MsgPack; <code>hash = fold_root</code> (e.g., sha256:‚Ä¶).</p><p><strong>Runtime</strong>: Echo‚Äôs fold engine executes the compiled IR. No dynamic I/O. No wall-clock. Pure.</p><p><strong>Binding</strong>: Every checkpoint and decision should record both policy_root and fold_root. If either changes, audits are explicit.</p><p>Example (new fields in spec):</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># folds/invoices.yaml (source)</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">version</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">inputs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gatos/journal/finance/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">reducers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">kind</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">map-join-lww</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;$.id&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">emit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;state/finance/invoices.json&quot;</span></span></code></pre></div><p>Compiler produces:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">folds/invoices.rgf</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     # compiled bytecode</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">folds/invoices.rgf.sha</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # contains fold_root = sha256:&lt;hex&gt;</span></span></code></pre></div><p>Checkpoints carry:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;state_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blake3:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;inputs_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blake3:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;policy_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sha256:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;fold_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sha256:‚Ä¶&quot;</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">     // NEW</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Why compiled?</p><ul><li>Determinism + speed + auditability.</li><li>YAML stays UX;</li><li>RGF is law.</li></ul><hr><h2 id="_2-echo-integration-‚Äî-do-dpo-rules-become-merge-strategy-for-sessions" tabindex="-1">2) Echo integration ‚Äî do DPO rules become merge strategy for sessions? <a class="header-anchor" href="#_2-echo-integration-‚Äî-do-dpo-rules-become-merge-strategy-for-sessions" aria-label="Permalink to &quot;2) Echo integration ‚Äî do DPO rules become merge strategy for sessions?&quot;">‚Äã</a></h2><p><a id="2"></a><a id="2-echo-integration--do-dpo-rules-become-merge-strategy-for-sessions"></a><a id="2-echo-integration-do-dpo-rules-become-merge-strategy-for-sessions"></a><strong>Yes</strong>. Session merges must be governed by the fold‚Äôs declared join lattice (for counters, sets, maps) and DPO rewrites (for typed graphs).</p><p>Per-fold merge contract:</p><ul><li><strong>Scalars</strong>: define lww or min/max explicitly.</li><li><strong>Sets</strong>: OR-set or 2P-set (declared).</li><li><strong>Counters</strong>: G-counter/PN-counter.</li><li><strong>Graphs</strong>: DPO with canonical match order (Echo provides).</li><li><strong>Conflict classes</strong>: anything not covered by a lattice or DPO rule becomes a governance conflict (record an event: <code>governance.conflict</code> with precise paths and rule ids).</li></ul><p>This makes gatos session merge a deterministic math operation, not a string diff.</p><hr><h2 id="_3-proof-system-‚Äî-zk-choice" tabindex="-1">3) Proof system ‚Äî ZK choice? <a class="header-anchor" href="#_3-proof-system-‚Äî-zk-choice" aria-label="Permalink to &quot;3) Proof system ‚Äî ZK choice?&quot;">‚Äã</a></h2><p><a id="3"></a><a id="3-proof-system--zk-choice"></a><a id="3-proof-system-zk-choice"></a></p><h3 id="phase-plan" tabindex="-1">Phase plan <a class="header-anchor" href="#phase-plan" aria-label="Permalink to &quot;Phase plan&quot;">‚Äã</a></h3><p><a id="phase-plan"></a></p><h4 id="v1-day-one" tabindex="-1">v1 (day-one) <a class="header-anchor" href="#v1-day-one" aria-label="Permalink to &quot;v1 (day-one)&quot;">‚Äã</a></h4><p><a id="v1-day-one"></a></p><ul><li>Commitment proofs (cheap, universal).</li><li>We record <code>inputs_root</code>, <code>output_root</code>, <code>policy_root</code>, <code>fold_root</code> and a <code>signature ‚Üí proof.fairness</code>.</li><li>Verifier recomputes the public roots and signature. <ul><li>No heavy crypto needed.</li></ul></li></ul><h4 id="v2-optional-pluggable" tabindex="-1">v2 (optional, pluggable) <a class="header-anchor" href="#v2-optional-pluggable" aria-label="Permalink to &quot;v2 (optional, pluggable)&quot;">‚Äã</a></h4><p><a id="v2-optional-pluggable"></a></p><ul><li>ZK proofs for selected folds.</li></ul><h3 id="trait" tabindex="-1">Trait <a class="header-anchor" href="#trait" aria-label="Permalink to &quot;Trait&quot;">‚Äã</a></h3><p><a id="trait"></a> Prover/Verifier with backends (Plonky2/Halo2/Risc0/STARKy). We don‚Äôt hard-bind to a library.</p><p>Start with small circuits (map-join-lww, counters, set membership) to prove no forbidden branch was taken.</p><p>Support proof aggregation (multi-step chain ‚Üí one proof) later.</p><h3 id="spec-tweak" tabindex="-1">Spec tweak <a class="header-anchor" href="#spec-tweak" aria-label="Permalink to &quot;Spec tweak&quot;">‚Äã</a></h3><p><a id="spec-tweak"></a> Add <code>fold_root</code> to proof envelope and make proof field type-tagged:</p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{ </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;proof&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;kind&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;commitment&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">&quot;bytes&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;...&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> } }</span></span></code></pre></div><hr><h2 id="_4-message-bus-scaling-‚Äî-changing-shard-count" tabindex="-1">4) Message bus scaling ‚Äî changing shard count <a class="header-anchor" href="#_4-message-bus-scaling-‚Äî-changing-shard-count" aria-label="Permalink to &quot;4) Message bus scaling ‚Äî changing shard count&quot;">‚Äã</a></h2><p><a id="4"></a><a id="4-message-bus-scaling--changing-shard-count"></a><a id="4-message-bus-scaling-changing-shard-count"></a> Use a versioned shard map + dual-write migration.</p><ul><li>Store topic config at <code>refs/gatos/mbus-config/&lt;topic&gt;.json</code>:</li></ul><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;shards&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">64</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;hash&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blake3&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;strategy&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;consistent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;from_version&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;migrate&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;dual-write&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Consistent hashing keeps most keys stable when shards changes.</p><p>Dual-write window:</p><ul><li>Publishers write to both old and new shard maps for a configurable epoch.</li><li>Consumers subscribe to both maps; dedupe by (topic, ulid).</li></ul><p>When ack lag on the old map is zero for N minutes, flip the active version and retire the old.</p><p>This gives smooth resharding with exactly-once semantics intact.</p><hr><h2 id="_5-policy-language-rgs-‚Äî-what-is-it-really" tabindex="-1">5) Policy language (<code>.rgs</code>) ‚Äî what is it really? <a class="header-anchor" href="#_5-policy-language-rgs-‚Äî-what-is-it-really" aria-label="Permalink to &quot;5) Policy language (\`.rgs\`) ‚Äî what is it really?&quot;">‚Äã</a></h2><p><a id="5"></a><a id="5-policy-language-rgs--what-is-it-really"></a><a id="5-policy-language-.rgs-what-is-it-really"></a> Small, pure rule DSL inspired by Datalog/Rego, compiled to <code>.rgc</code> bytecode.</p><h3 id="features" tabindex="-1">Features <a class="header-anchor" href="#features" aria-label="Permalink to &quot;Features&quot;">‚Äã</a></h3><p><a id="features"></a></p><ul><li>Booleans,</li><li>numeric/string ops,</li><li>set membership,</li><li>label checks,</li><li>actor/trust lookups.</li><li>No loops,</li><li>no I/O,</li><li>no time.</li><li>Strictly total functions.</li></ul><h3 id="shape" tabindex="-1">Shape <a class="header-anchor" href="#shape" aria-label="Permalink to &quot;Shape&quot;">‚Äã</a></h3><p><a id="shape"></a></p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">when</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: { </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">intent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;write&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">path</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;gatos/journal/finance/**&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">allow_if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;caps includes &#39;journal:append&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;trust[actor].level &gt;= 2&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">deny_if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;labels contains &#39;private&#39; and remote != &#39;internal&#39;&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">audit</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span></code></pre></div><h3 id="compilation" tabindex="-1">Compilation <a class="header-anchor" href="#compilation" aria-label="Permalink to &quot;Compilation&quot;">‚Äã</a></h3><p><a id="compilation"></a><code>.rgs</code> ‚Üí <code>.rgc</code> (CBOR), policy_root = SHA-256 of <code>.rgc</code>.</p><h3 id="library" tabindex="-1">Library <a class="header-anchor" href="#library" aria-label="Permalink to &quot;Library&quot;">‚Äã</a></h3><p><a id="library"></a> Standard predicates:</p><ul><li>includes,</li><li>contains,</li><li>in_cidr,</li><li>has_cap,</li><li>before_epoch,</li><li>etc.</li></ul><h3 id="explainability" tabindex="-1">Explainability <a class="header-anchor" href="#explainability" aria-label="Permalink to &quot;Explainability&quot;">‚Äã</a></h3><p><a id="explainability"></a></p><ul><li>Compiler annotates rule ids;</li><li>gate returns <code>Deny(rule_id, reason)</code> deterministically.</li></ul><hr><h2 id="obvious-gaps-we-should-close-specification-supplements" tabindex="-1">Obvious gaps we should close (specification supplements) <a class="header-anchor" href="#obvious-gaps-we-should-close-specification-supplements" aria-label="Permalink to &quot;Obvious gaps we should close (specification supplements)&quot;">‚Äã</a></h2><p><a id="obvious-gaps-we-should-close-specification-supplements"></a></p><h3 id="_1-bind-fold-version" tabindex="-1">1. <strong>Bind fold version</strong> <a class="header-anchor" href="#_1-bind-fold-version" aria-label="Permalink to &quot;1. **Bind fold version**&quot;">‚Äã</a></h3><p><a id="1-bind-fold-version"></a><a id="1.-bind-fold-version"></a> We added <code>fold_root</code> above ‚Äî make it mandatory anywhere <code>policy_root</code> is mandatory.</p><h3 id="_2-canonical-json-rules" tabindex="-1">2. <strong>Canonical JSON rules</strong> <a class="header-anchor" href="#_2-canonical-json-rules" aria-label="Permalink to &quot;2. **Canonical JSON rules**&quot;">‚Äã</a></h3><p><a id="2-canonical-json-rules"></a><a id="2.-canonical-json-rules"></a></p><ul><li>Call out key sorting,</li><li>UTF-8 normalization,</li><li>and number encoding explicitly (<code>u64</code>/<code>s128</code>/<code>fixed-point</code>) so hashes are cross-platform bit-exact.</li></ul><h3 id="_3-error-code-taxonomy-for-jsonl" tabindex="-1">3. Error code taxonomy (for JSONL) <a class="header-anchor" href="#_3-error-code-taxonomy-for-jsonl" aria-label="Permalink to &quot;3. Error code taxonomy (for JSONL)&quot;">‚Äã</a></h3><p><a id="3-error-code-taxonomy-for-jsonl"></a><a id="3.-error-code-taxonomy-for-jsonl"></a></p><ul><li><code>POLICY_DENY</code>,</li><li><code>CAP_EXPIRED</code>,</li><li><code>FF_VIOLATION</code>,</li><li><code>ACK_TIMEOUT</code>,</li><li><code>DUP_COMMIT</code>,</li><li><code>EPOCH_BROKEN</code>,</li><li><code>PROOF_INVALID</code>.</li></ul><h3 id="_4-resource-uris" tabindex="-1">4. Resource URIs <a class="header-anchor" href="#_4-resource-uris" aria-label="Permalink to &quot;4. Resource URIs&quot;">‚Äã</a></h3><p><a id="4-resource-uris"></a><a id="4.-resource-uris"></a></p><ul><li>Standardize <code>gatos://&lt;repo&gt;/&lt;ns&gt;/&lt;path&gt;</code> as the resource field everywhere.</li></ul><h3 id="_5-idempotency" tabindex="-1">5. Idempotency <a class="header-anchor" href="#_5-idempotency" aria-label="Permalink to &quot;5. Idempotency&quot;">‚Äã</a></h3><p><a id="5-idempotency"></a><a id="5.-idempotency"></a></p><ul><li>Require ulid stability + idempotency keys for exec/bus intents;</li><li>Deny repeats unless allowed by QoS.</li></ul><h3 id="_6-key-rotation" tabindex="-1">6. Key rotation <a class="header-anchor" href="#_6-key-rotation" aria-label="Permalink to &quot;6. Key rotation&quot;">‚Äã</a></h3><p><a id="6-key-rotation"></a><a id="6.-key-rotation"></a> Grant chain fields (prev, revokes) and a rotation checklist in spec.</p><hr><blockquote><p>[!faq] ‚ÄúAre we missing any big pieces?‚Äù (Short list)</p></blockquote><p><strong>Docs for profiles</strong> (<code>local</code> / <code>push-gate</code> / <code>SaaS</code>) with defaults (who enforces what, where).</p><p><strong>Doctor + Metrics</strong>: implementation <strong>MUST</strong> ship <code>/healthz</code>, <code>/readyz</code>, <code>/metrics</code> and <code>gatos doctor</code>. (We wrote it in <code>TECH-SPEC</code>; surface it in <code>SPEC</code>‚Äôs normative section with metric names.)</p><p><strong>KV &amp; Graph facades</strong>: optional subcommands that expose familiar semantics on top of journals/folds (gatos kv, gatos graph query). Makes first-contact easier.</p><p><strong>Resilience helpers</strong>: an out-of-the-box repair tool to re-stitch epochs, roll caches, and heal broken refs.</p><hr><h2 id="top-5-use-cases-and-if-we-meet-them" tabindex="-1">Top 5 use-cases (and if we meet them) <a class="header-anchor" href="#top-5-use-cases-and-if-we-meet-them" aria-label="Permalink to &quot;Top 5 use-cases (and if we meet them)&quot;">‚Äã</a></h2><p><a id="top-5-use-cases-and-if-we-meet-them"></a></p><h3 id="_1-regulated-config-feature-flags" tabindex="-1">1.Regulated config / feature flags <a class="header-anchor" href="#_1-regulated-config-feature-flags" aria-label="Permalink to &quot;1.Regulated config / feature flags&quot;">‚Äã</a></h3><p><a id="1regulated-config--feature-flags"></a><a id="1.regulated-config-feature-flags"></a></p><ul><li>Needs: signed appends, RLS, RYW, bounded history.</li><li>We meet: journals + policy gate + epochs + (optional) push-gate.</li><li>Add: canned policy templates + gatos doctor for GC/epoch sanity ‚Üí ‚úÖ production-grade.</li></ul><h3 id="_2-supply-chain-deploy-attestation" tabindex="-1">2.Supply-chain / deploy attestation <a class="header-anchor" href="#_2-supply-chain-deploy-attestation" aria-label="Permalink to &quot;2.Supply-chain / deploy attestation&quot;">‚Äã</a></h3><p><a id="2supply-chain--deploy-attestation"></a><a id="2.supply-chain-deploy-attestation"></a></p><ul><li>Needs: signed events, multi-sig policy changes, human/JSON logs, offline verify.</li><li>We meet: Shiplog DNA + proof envelopes v1.</li><li>Add: ‚Äúevidence pack‚Äù command that bundles logs + proof ‚Üí ‚úÖ audit-ready.</li></ul><h3 id="_3-air-gapped-ml-registry" tabindex="-1">3.Air-gapped ML registry <a class="header-anchor" href="#_3-air-gapped-ml-registry" aria-label="Permalink to &quot;3.Air-gapped ML registry&quot;">‚Äã</a></h3><p><a id="3air-gapped-ml-registry"></a><a id="3.air-gapped-ml-registry"></a></p><ul><li>Needs: huge blobs, provenance, selective export, encrypted storage.</li><li>We meet: opaque pointers + CAS + epochs.</li><li>Add: rekey tool + export policies ‚Üí ‚úÖ.</li></ul><h3 id="_4-llm-multi-agent-orchestration" tabindex="-1">4.LLM multi-agent orchestration <a class="header-anchor" href="#_4-llm-multi-agent-orchestration" aria-label="Permalink to &quot;4.LLM multi-agent orchestration&quot;">‚Äã</a></h3><p><a id="4llm-multi-agent-orchestration"></a><a id="4.llm-multi-agent-orchestration"></a></p><ul><li>Needs: pub/sub, exactly-once, backpressure, capability tokens.</li><li>We meet: bus QoS + caps + acks/commit.</li><li>Add: shard-map/versioning + subscription windows ‚Üí ‚úÖ at scale.</li></ul><h3 id="_5-cross-app-data-sharing-rls-gated-state" tabindex="-1">5.Cross-app data sharing (RLS-gated state) <a class="header-anchor" href="#_5-cross-app-data-sharing-rls-gated-state" aria-label="Permalink to &quot;5.Cross-app data sharing (RLS-gated state)&quot;">‚Äã</a></h3><p><a id="5cross-app-data-sharing-rls-gated-state"></a><a id="5.cross-app-data-sharing-rls-gated-state"></a></p><ul><li>Needs: stable materialized views, policy-consistent reads across repos.</li><li>We meet: refs/gatos/state/** as public contract + shared policy bundles.</li><li>Add: Wesley target that emits both fold + RLS bundle ‚Üí ‚úÖ smooth.</li></ul><hr><h2 id="compare-contrast-adjacent-tech" tabindex="-1">Compare &amp; contrast (adjacent tech) <a class="header-anchor" href="#compare-contrast-adjacent-tech" aria-label="Permalink to &quot;Compare &amp; contrast (adjacent tech)&quot;">‚Äã</a></h2><p><a id="compare--contrast-adjacent-tech"></a><a id="compare-contrast-adjacent-tech"></a></p><h3 id="kafka-eventstoredb-‚Äî-event-logs-at-scale" tabindex="-1">Kafka / EventStoreDB ‚Äî event logs at scale <a class="header-anchor" href="#kafka-eventstoredb-‚Äî-event-logs-at-scale" aria-label="Permalink to &quot;Kafka / EventStoreDB ‚Äî event logs at scale&quot;">‚Äã</a></h3><p><a id="kafka--eventstoredb--event-logs-at-scale"></a><a id="kafka-eventstoredb-event-logs-at-scale"></a></p><ul><li>not offline-first;</li><li>no built-in deterministic fold proofs;</li><li>no Git audit trail.</li></ul><h4 id="gatos" tabindex="-1">GATOS <a class="header-anchor" href="#gatos" aria-label="Permalink to &quot;GATOS&quot;">‚Äã</a></h4><p><a id="gatos"></a></p><ul><li>lower TPS,</li><li>higher assurance,</li><li>portable,</li><li>auditable,</li><li>Git-native.</li></ul><h3 id="dolt-lakefs-‚Äî-data-versioning-with-git-like-semantics" tabindex="-1">Dolt / LakeFS ‚Äî data versioning with Git-like semantics <a class="header-anchor" href="#dolt-lakefs-‚Äî-data-versioning-with-git-like-semantics" aria-label="Permalink to &quot;Dolt / LakeFS  ‚Äî data versioning with Git-like semantics&quot;">‚Äã</a></h3><p><a id="dolt--lakefs---data-versioning-with-git-like-semantics"></a><a id="dolt-lakefs-data-versioning-with-git-like-semantics"></a></p><h4 id="gatos-1" tabindex="-1">GATOS <a class="header-anchor" href="#gatos-1" aria-label="Permalink to &quot;GATOS&quot;">‚Äã</a></h4><p><a id="gatos-1"></a><a id="gatos"></a></p><ul><li>uses Git itself as database + runtime + policy plane;</li><li>no heavyweight DB server.</li></ul><h3 id="dvc-pachyderm-‚Äî-ml-artifact-pipeline-versioning" tabindex="-1">DVC / Pachyderm ‚Äî ML artifact + pipeline versioning <a class="header-anchor" href="#dvc-pachyderm-‚Äî-ml-artifact-pipeline-versioning" aria-label="Permalink to &quot;DVC / Pachyderm ‚Äî ML artifact + pipeline versioning&quot;">‚Äã</a></h3><p><a id="dvc--pachyderm--ml-artifact--pipeline-versioning"></a><a id="dvc-pachyderm-ml-artifact-pipeline-versioning"></a></p><h4 id="gatos-2" tabindex="-1">GATOS <a class="header-anchor" href="#gatos-2" aria-label="Permalink to &quot;GATOS&quot;">‚Äã</a></h4><p><a id="gatos-2"></a><a id="gatos"></a></p><ul><li>adds policy,</li><li>proofs,</li><li>and deterministic compute on the same DAG;</li><li>no external control plane.</li></ul><h2 id="nix-guix-‚Äî-reproducible-builds" tabindex="-1">Nix/Guix ‚Äî reproducible builds <a class="header-anchor" href="#nix-guix-‚Äî-reproducible-builds" aria-label="Permalink to &quot;Nix/Guix ‚Äî reproducible builds&quot;">‚Äã</a></h2><p><a id="nixguix--reproducible-builds"></a><a id="nixguix-reproducible-builds"></a><strong>GATOS</strong>:</p><ul><li>generalizes reproducibility to runtime state, messages, and governance.</li></ul><h2 id="blockchains-‚Äî-global-consensus" tabindex="-1">Blockchains ‚Äî global consensus <a class="header-anchor" href="#blockchains-‚Äî-global-consensus" aria-label="Permalink to &quot;Blockchains ‚Äî global consensus&quot;">‚Äã</a></h2><p><a id="blockchains--global-consensus"></a><a id="blockchains-global-consensus"></a></p><ul><li>huge cost.</li></ul><p><strong>GATOS</strong>:</p><ul><li>local determinism + cryptographic attestations,</li><li>no global chain,</li><li>no miners.</li></ul><hr><h2 id="new-features-this-meditation-suggests" tabindex="-1">New features this meditation suggests <a class="header-anchor" href="#new-features-this-meditation-suggests" aria-label="Permalink to &quot;New features this meditation suggests&quot;">‚Äã</a></h2><p><a id="new-features-this-meditation-suggests"></a></p><ol><li><code>fold_root</code> binding across checkpoints and proofs (spec update).</li><li>Versioned shard maps and dual-write migration for the bus.</li><li>Proof envelopes v1 as a hard requirement for ‚Äúprivileged‚Äù folds; ZK optional.</li><li>Wesley‚ÜíGATOS target to generate <code>*.rgf</code> and <code>.rgc</code> bundles, plus schema manifests.</li><li>KV and Graph facades as on-ramps: <code>gatos kv</code>, <code>gatos graph</code>.</li><li>Policy templates: <code>gatos policy init --template minimal|regulated|airgapped</code>.</li><li>Doctor is mandatory (not ‚Äúnice-to-have‚Äù).</li></ol><hr><h2 id="concrete-next-steps" tabindex="-1">Concrete next steps <a class="header-anchor" href="#concrete-next-steps" aria-label="Permalink to &quot;Concrete next steps&quot;">‚Äã</a></h2><p><a id="concrete-next-steps"></a></p><ul><li><strong>Spec delta</strong>: <ul><li>add <code>fold_root</code> everywhere <code>policy_root</code> appears;</li><li>define canonical JSON rules;</li><li>add error codes.</li></ul></li><li><strong>Compiler</strong>: <ul><li>build <code>rgf</code> bytecode generator (YAML ‚Üí Echo IR ‚Üí CBOR).</li></ul></li><li><strong>Gate</strong>: <ul><li>finalize <code>.rgs</code> grammar + deterministic interpreter;</li><li>emit rule ids in Deny.</li></ul></li><li><strong>Bus</strong>: <ul><li><code>mbus-config/&lt;topic&gt;.json</code> with versioned shard maps + dual-write migration.</li></ul></li><li><strong>Proofs</strong>: <ul><li>implement commitment proofs today;</li><li>leave ZK behind a trait.</li></ul></li><li><strong>CLI</strong>: <ul><li><code>gatos doctor</code>,</li><li><code>gatos epoch new</code>,</li><li><code>gatos prove/verify</code>,</li><li><code>gatos bus {publish,subscribe}</code>.</li></ul></li></ul><p>Ship those, and this stops being ‚Äújust‚Äù a gorgeous spec and becomes an operating surface people can run.</p><hr><blockquote><p>[!faq] Could the deterministic byte code just be Lua running on an echo-Lua VM w/echo&#39;s deterministic floats etc?</p></blockquote><p><strong>Short answer</strong>: Yes ‚Äî with constraints. You can absolutely make the ‚Äúdeterministic bytecode‚Äù be Lua on an Echo-Lua VM if you run a restricted, deterministic profile and you do not rely on stock Lua bytecode for portability. Treat Lua as the authoring language, compile it to a portable, canonical IR, and execute it on a VM that enforces Echo‚Äôs determinism rules.</p><p>Below is the concrete plan.</p><hr><h3 id="‚úÖ-what-works-and-what-does-not" tabindex="-1">‚úÖ What works (and what does not) <a class="header-anchor" href="#‚úÖ-what-works-and-what-does-not" aria-label="Permalink to &quot;‚úÖ What works (and what does not)&quot;">‚Äã</a></h3><p><a id="-what-works-and-what-does-not"></a><a id="what-works-and-what-does-not"></a> Use Lua as the source, not the on-disk bytecode</p><ul><li>Do: Parse Lua source ‚Üí canonical AST ‚Üí Echo Lua IR (call it ELC), serialize to CBOR/MsgPack, and hash that (<code>fold_root</code>).</li><li>Don‚Äôt: Ship stock Lua precompiled chunks (luac). They‚Äôre not portable across Lua versions/architectures (endianness, ints/floats, build flags). We need a portable, stable compiled form.</li></ul><h3 id="deterministic-runtime-profile-echolua" tabindex="-1">Deterministic runtime profile (‚ÄúEchoLua‚Äù) <a class="header-anchor" href="#deterministic-runtime-profile-echolua" aria-label="Permalink to &quot;Deterministic runtime profile (‚ÄúEchoLua‚Äù)&quot;">‚Äã</a></h3><p><a id="deterministic-runtime-profile-echolua"></a> You‚Äôll run the IR on a small VM with a deterministic standard library and a pure execution model:</p><table tabindex="0"><thead><tr><th style="text-align:left;">Area</th><th style="text-align:left;">Default Lua</th><th style="text-align:left;">EchoLua profile (deterministic)</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>Time/OS</strong></td><td style="text-align:left;">os.clock, os.time, io.*</td><td style="text-align:left;">Removed (forbidden)</td></tr><tr><td style="text-align:left;"><strong>Random</strong></td><td style="text-align:left;">math.random (MT)</td><td style="text-align:left;">Replaced with deterministic PRNG (e.g., PCG/Xoroshiro) seeded from {inputs_root, policy_root, fold_root}</td></tr><tr><td style="text-align:left;"><strong>Floats</strong></td><td style="text-align:left;">IEEE-754 via host FPU</td><td style="text-align:left;">Software float or fixed-point with defined rounding + NaN canonicalization (or integer/fixed-point only)</td></tr><tr><td style="text-align:left;"><strong>Iteration order</strong></td><td style="text-align:left;">pairs() order unspecified</td><td style="text-align:left;">pairs shadowed by dpairs() that sorts keys deterministically; ipairs allowed for arrays</td></tr><tr><td style="text-align:left;"><strong>Tables &amp; hashing</strong></td><td style="text-align:left;">Hash seed randomized per process</td><td style="text-align:left;">Fixed hash seed inside VM; but you still must not rely on hash order</td></tr><tr><td style="text-align:left;"><strong>Coroutines</strong></td><td style="text-align:left;">Arbitrary yields</td><td style="text-align:left;">Disallowed (folds are pure; no scheduler)</td></tr><tr><td style="text-align:left;"><strong>Metamethods (__gc)</strong></td><td style="text-align:left;">Finalizer order GC-dependent</td><td style="text-align:left;">Disallowed; GC visible effects forbidden</td></tr><tr><td style="text-align:left;"><strong>FFI/dynamic load</strong></td><td style="text-align:left;">possible via add-ons</td><td style="text-align:left;">Forbidden</td></tr><tr><td style="text-align:left;"><strong>Math (exp/log/sin)</strong></td><td style="text-align:left;">Host-lib accuracy varies</td><td style="text-align:left;">Deterministic math lib (CR-libm-style or pure integer/decimal path)</td></tr></tbody></table><p><strong>TL;DR</strong>: fold execution must be pure, total, side-effect free. Same inputs ‚áí same bytes.</p><hr><h2 id="üéØ-architecture" tabindex="-1">üéØ Architecture <a class="header-anchor" href="#üéØ-architecture" aria-label="Permalink to &quot;üéØ Architecture&quot;">‚Äã</a></h2><p><a id="-architecture"></a><a id="architecture"></a></p><h3 id="_1-compilation-pipeline" tabindex="-1">1) Compilation pipeline <a class="header-anchor" href="#_1-compilation-pipeline" aria-label="Permalink to &quot;1) Compilation pipeline&quot;">‚Äã</a></h3><p><a id="1"></a><a id="1-compilation-pipeline"></a></p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Lua source  ‚îÄ‚îÄparse/normalize‚îÄ‚îÄ‚ñ∫ AST ‚îÄ‚îÄlower‚îÄ‚îÄ‚ñ∫ ELC (Echo Lua IR)</span></span>
<span class="line"><span>                                         ‚îÇ</span></span>
<span class="line"><span>                                         ‚îî‚îÄ‚ñ∫ CBOR bytes  (hash = fold_root)</span></span></code></pre></div><ul><li><strong>Normalize</strong>: remove syntactic sugar, canonicalize constant folding, resolve upvalues.</li><li><strong>Lowering</strong>: emit a small, explicitly typed IR (ops like <code>map_join</code>, <code>reduce</code>, <code>emit_json</code>, <code>cmp_sort</code>, etc.) + a minimal VM op set (LOADK, GET, SET, CALL, RET, ‚Ä¶).</li><li><strong>Hash</strong>: <code>fold_root = sha256(ELC_bytes)</code>. Record alongside <code>policy_root</code> anywhere <code>state_root</code> is recorded.</li></ul><h3 id="_2-execution" tabindex="-1">2) Execution <a class="header-anchor" href="#_2-execution" aria-label="Permalink to &quot;2) Execution&quot;">‚Äã</a></h3><p><a id="2"></a><a id="2-execution"></a> The EchoLua VM interprets ELC with:</p><ul><li>A pure deterministic math layer (either fixed-point or software floats; pick one and lock rounding mode).</li><li>Canonical JSON emission (UTF-8 normalized, sorted keys, fixed number encoding).</li><li>Deterministic PRNG only if you explicitly allow it in a fold (most folds shouldn‚Äôt use it).</li></ul><h3 id="_3-standard-library-deterministic-subset" tabindex="-1">3) Standard library (deterministic subset) <a class="header-anchor" href="#_3-standard-library-deterministic-subset" aria-label="Permalink to &quot;3) Standard library (deterministic subset)&quot;">‚Äã</a></h3><p><a id="3"></a><a id="3-standard-library-deterministic-subset"></a></p><ul><li><code>table</code>: <code>dkeys</code>, <code>dvalues</code>, <code>dsort</code>, <code>dpairs(t)</code> (sorted iteration).</li><li><code>json</code>: <code>encode_canonical</code>, <code>decode_strict</code>.</li><li><code>math</code>: <code>add</code>/<code>sub</code>/<code>mul</code>/<code>div</code> (deterministic), optional <code>exp</code>/<code>log</code>/<code>sin</code>/<code>cos</code> via a fixed, correctly rounded library. If you can, prefer fixed-point/integers in folds for simplicity and speed.</li><li><code>set</code>, <code>counter</code>: OR-Set/2P-Set primitives; G/PN counters; deterministic lattice joins.</li><li>No debug, package, io, os.</li></ul><hr><h2 id="üß™-determinism-hazards-how-we-neutralize-them" tabindex="-1">üß™ Determinism hazards &amp; how we neutralize them <a class="header-anchor" href="#üß™-determinism-hazards-how-we-neutralize-them" aria-label="Permalink to &quot;üß™ Determinism hazards &amp; how we neutralize them&quot;">‚Äã</a></h2><p><a id="-determinism-hazards--how-we-neutralize-them"></a><a id="determinism-hazards-how-we-neutralize-them"></a></p><h3 id="_1-floating-point-drift" tabindex="-1">1. Floating-point drift <a class="header-anchor" href="#_1-floating-point-drift" aria-label="Permalink to &quot;1. Floating-point drift&quot;">‚Äã</a></h3><p><a id="1-floating-point-drift"></a><a id="1.floating-point-drift"></a></p><ul><li>Use software float (e.g., SoftFloat-style) or fixed-point (e.g., Q32.32) for all math in folds.</li><li>Canonicalize NaNs and rounding to ties-to-even.</li><li>If you need transcendental functions, ship a deterministic math lib (CR-libm-like) and pin versions.</li></ul><h3 id="_2-table-iteration-order" tabindex="-1">2.Table iteration order <a class="header-anchor" href="#_2-table-iteration-order" aria-label="Permalink to &quot;2.Table iteration order&quot;">‚Äã</a></h3><p><a id="2table-iteration-order"></a><a id="2.table-iteration-order"></a></p><ul><li>Forbid raw pairs; replace with dpairs that sorts keys by canonical comparator.</li><li>Lint/compile error on pairs/metamethod __pairs.</li></ul><h3 id="_3-randomness-time" tabindex="-1">3.Randomness/time <a class="header-anchor" href="#_3-randomness-time" aria-label="Permalink to &quot;3.Randomness/time&quot;">‚Äã</a></h3><p><a id="3randomnesstime"></a><a id="3.randomnesstime"></a></p><ul><li>Remove math.random, os.time. Provide rng() that returns a stream seeded from {inputs_root, policy_root, fold_root} and document it as discouraged.</li></ul><h3 id="_4-gc-finalizers" tabindex="-1">4.GC/finalizers <a class="header-anchor" href="#_4-gc-finalizers" aria-label="Permalink to &quot;4.GC/finalizers&quot;">‚Äã</a></h3><p><a id="4gcfinalizers"></a><a id="4.gcfinalizers"></a></p><ul><li>Disallow __gc metatables; VM forbids finalizers during fold execution.</li></ul><h3 id="_5-bytecode-portability" tabindex="-1">5.Bytecode portability <a class="header-anchor" href="#_5-bytecode-portability" aria-label="Permalink to &quot;5.Bytecode portability&quot;">‚Äã</a></h3><p><a id="5bytecode-portability"></a><a id="5.bytecode-portability"></a></p><ul><li>Never ship stock Lua bytecode. Only ship ELC (your portable IR) with a stable encoder.</li></ul><h3 id="_6-string-hashing-locales" tabindex="-1">6.String hashing / locales <a class="header-anchor" href="#_6-string-hashing-locales" aria-label="Permalink to &quot;6.String hashing / locales&quot;">‚Äã</a></h3><p><a id="6string-hashing--locales"></a><a id="6.string-hashing-locales"></a></p><ul><li>VM sets fixed hash seed internally; string compare uses pure bytewise lexicographic (UTF-8), locale-independent.</li></ul><hr><h3 id="where-lua-shines-here" tabindex="-1">Where Lua shines here <a class="header-anchor" href="#where-lua-shines-here" aria-label="Permalink to &quot;Where Lua shines here&quot;">‚Äã</a></h3><p><a id="where-lua-shines-here"></a></p><ul><li><strong>Developer experience</strong>: great; tiny language, loved by game engines, easy to sandbox.</li><li><strong>Embedding</strong>: trivial in Rust/C; small binary; fast interpretive performance for control flow.</li><li><strong>Safety</strong>: easy to freeze the global env and hand a tiny stdlib.</li></ul><hr><h2 id="spec-deltas-to-support-echolua" tabindex="-1">Spec deltas to support EchoLua <a class="header-anchor" href="#spec-deltas-to-support-echolua" aria-label="Permalink to &quot;Spec deltas to support EchoLua&quot;">‚Äã</a></h2><p><a id="spec-deltas-to-support-echolua"></a></p><h3 id="add-these-to-spec-tech-spec" tabindex="-1">Add these to <code>SPEC/TECH-SPEC</code> <a class="header-anchor" href="#add-these-to-spec-tech-spec" aria-label="Permalink to &quot;Add these to \`SPEC/TECH-SPEC\`&quot;">‚Äã</a></h3><p><a id="add-these-to-spectech-spec"></a> 1.Fold compilation outputs</p><ul><li>fold_root (SHA-256 of ELC bytes) MUST be recorded anywhere policy_root is recorded (events, checkpoints, proofs).</li></ul><p>2.Canonical JSON rules</p><ul><li>Keys sorted lexicographically; UTF-8 NFC; numeric encoding fixed (decimals or integers only); no trailing zeros; set a single representation for -0.</li></ul><p>3.Deterministic VM profile</p><ul><li>Define the forbidden modules (io, os, debug, package) and replaced functions (pairs‚Üídpairs, math.random‚Üírng), plus the float/fixed-point policy.</li></ul><p>4.Linter rules (build-time)</p><ul><li>Hard fail on: pairs, coroutines, metamethods __gc/__pairs, any import outside allowed stdlib, and any non-canonical numeric literal.</li></ul><p>5.Proof envelopes</p><ul><li>Include fold_root in the proof.fairness envelope alongside {inputs_root, output_root, policy_root}.</li></ul><hr><h2 id="minimal-example" tabindex="-1">Minimal example <a class="header-anchor" href="#minimal-example" aria-label="Permalink to &quot;Minimal example&quot;">‚Äã</a></h2><p><a id="minimal-example"></a></p><h3 id="folds-invoices-lua-authoring" tabindex="-1">folds/invoices.lua (authoring) <a class="header-anchor" href="#folds-invoices-lua-authoring" aria-label="Permalink to &quot;folds/invoices.lua (authoring)&quot;">‚Äã</a></h3><p><a id="foldsinvoiceslua-authoring"></a><a id="foldsinvoices.lua-authoring"></a></p><div class="language-lua vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">lua</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">-- Pure fold: Last-writer-wins by invoice id, deterministic order.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fold</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(events)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> by_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _, e </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dpairs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(events) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              -- dpairs sorts by ULID</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;intent.exec.insert_invoice&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      by_id[id] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id, amount</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">amount</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;draft&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">type</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ==</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;intent.exec.approve_invoice&quot; </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">payload</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> by_id[id] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">then</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> by_id[id].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">status</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;approved&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; by_id[id].</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ts</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulid</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> emit_json_canonical</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;state/finance/invoices.json&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, by_id)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="build" tabindex="-1">Build <a class="header-anchor" href="#build" aria-label="Permalink to &quot;Build&quot;">‚Äã</a></h3><p><a id="build"></a></p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gatos</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> foldc</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> folds/invoices.lua</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -o</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> folds/invoices.rgf</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># outputs fold_root = sha256:...</span></span></code></pre></div><h3 id="checkpoint-conceptual" tabindex="-1">Checkpoint (conceptual) <a class="header-anchor" href="#checkpoint-conceptual" aria-label="Permalink to &quot;Checkpoint (conceptual)&quot;">‚Äã</a></h3><p><a id="checkpoint-conceptual"></a></p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;state_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blake3:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;inputs_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;blake3:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;policy_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sha256:‚Ä¶&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  &quot;fold_root&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;sha256:‚Ä¶&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><hr><h2 id="performance-notes" tabindex="-1">Performance notes <a class="header-anchor" href="#performance-notes" aria-label="Permalink to &quot;Performance notes&quot;">‚Äã</a></h2><p><a id="performance-notes"></a></p><ul><li>Interpreted Lua is plenty for control + small reductions;</li><li>heavy math should be in Echo‚Äôs native reducers (map-joins, counters, OR-sets) callable from Lua as intrinsics.</li><li>Keep the VM single-threaded per fold;</li><li>parallelize across partitions upstream (multiple sessions/namespaces) to preserve determinism without scheduler complexity.</li></ul><hr><h2 id="test-matrix-lock-this-down" tabindex="-1">Test matrix (lock this down) <a class="header-anchor" href="#test-matrix-lock-this-down" aria-label="Permalink to &quot;Test matrix (lock this down)&quot;">‚Äã</a></h2><p><a id="test-matrix-lock-this-down"></a></p><ul><li>Golden vectors across: Linux (glibc &amp; musl), macOS ARM, Windows, WASM.</li><li>Folds using integers, fixed-point, (optional) software floats with transcendental functions.</li><li>Lints catching pairs, time/random, coroutines.</li><li>Poison tests: NaN propagation, signed zero, hash collisions, iteration order.</li></ul><hr><h2 id="bottom-line" tabindex="-1">Bottom line <a class="header-anchor" href="#bottom-line" aria-label="Permalink to &quot;Bottom line&quot;">‚Äã</a></h2><p><a id="bottom-line"></a> Yes: make the deterministic ‚Äúbytecode‚Äù Lua-authored, Echo-compiled, and VM-enforced. No: don‚Äôt trust raw Lua bytecode or the stock standard library.</p><p>Do it as EchoLua:</p><ul><li>Lua for ergonomics,</li><li>Echo for determinism,</li><li>ELC for portable compiled form,</li><li>A tiny, pure stdlib,</li><li>And a linter that turns foot-guns into build errors.</li></ul><p>We get a friendly developer experience and the bit-for-bit guarantees GATOS demands.</p>`,242)])])}const k=a(l,[["render",o]]);export{u as __pageData,k as default};
