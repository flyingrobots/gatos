services:
  ci-diagrams:
    # node:20 pinned by digest for reproducibility
    image: node@sha256:47dacd49500971c0fbe602323b2d04f6df40a933b123889636fc1f76bf69f58a
    working_dir: /work
    volumes:
      - .:/work
    environment:
      MERMAID_MAX_PARALLEL: ${MERMAID_MAX_PARALLEL:-6}
      MERMAID_CLI_VERSION: ${MERMAID_CLI_VERSION:-10.9.0}
      PUPPETEER_EXECUTABLE_PATH: ""
    command: ["node", "scripts/mermaid/generate.mjs", "--all"]

  ci-schemas:
    image: node@sha256:47dacd49500971c0fbe602323b2d04f6df40a933b123889636fc1f76bf69f58a
    working_dir: /work
    volumes:
      - .:/work
    command: ["bash", "./scripts/validate_schemas.sh"]

  ci-markdownlint:
    image: node@sha256:47dacd49500971c0fbe602323b2d04f6df40a933b123889636fc1f76bf69f58a
    working_dir: /work
    volumes:
      - .:/work
    command: [
      "npx",
      "-y",
      "markdownlint-cli",
      "**/*.md",
      "--config",
      ".markdownlint.json",
    ]

  ci-tests:
    image: rust:1.82-slim-bullseye
    working_dir: /work
    environment:
      GATOS_TEST_IN_DOCKER: "1"
      CARGO_TERM_COLOR: always
    volumes:
      - .:/work
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/work/target
    command: ["bash", "-lc", "apt-get update && apt-get install -y pkg-config libssl-dev && cargo test --workspace --locked"]

volumes:
  cargo-cache:
  target-cache:
